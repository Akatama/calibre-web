#!/bin/bash

# Configuration
XKLB_EXECUTABLE="${XKLB_EXECUTABLE:-lb}"
TMP_DOWNLOADS_PATH="/library/downloads/calibre-web"
LOG_FILE="/var/log/xklb.log"
SURVEY_DB_FILE="${TMP_DOWNLOADS_PATH}/survey.db"
URL="$1"

mkdir -p ${TMP_DOWNLOADS_PATH}

# Function to log messages
log() {
    echo "$(date +'%Y-%m-%d %H:%M:%S') - $1" | tee -a ${LOG_FILE}
}

# Check if xklb is installed
if ! command -v "${XKLB_EXECUTABLE}" &> /dev/null
then
    log "xklb could not be found. Please install xklb and try again."
    exit 1
fi

# Check if the user provided any arguments
if [ $# -eq 0 ]
then
    log "No arguments provided. Please provide a URL to download."
    exit 1
fi

# Validate URL
if [[ ! ${URL} =~ ^http[s]?:// ]]
then
    log "Invalid URL provided. Please provide a valid URL to download."
    exit 1
fi

log "Moving ${SURVEY_DB_FILE} aside if it already exists."
mv ${SURVEY_DB_FILE} ${SURVEY_DB_FILE}.$(date +%F_%T_%Z) || true
log "Running command: ${XKLB_EXECUTABLE} tubeadd ${SURVEY_DB_FILE} ${URL} --verbose && ${XKLB_EXECUTABLE} dl ${SURVEY_DB_FILE} --prefix ${TMP_DOWNLOADS_PATH} --extractor-config "writethumbnail=True" --video ${URL} --verbose"
OUTPUT=$(${XKLB_EXECUTABLE} tubeadd ${SURVEY_DB_FILE} ${URL} --verbose && \
        ${XKLB_EXECUTABLE} dl ${SURVEY_DB_FILE} --prefix ${TMP_DOWNLOADS_PATH} --extractor-config "writethumbnail=True" \
        --video ${URL} --verbose)

if [ $? -ne 0 ]; then
    log "An error occurred while running the command. Output: ${OUTPUT}"
    exit 1
fi

log "Download completed successfully."

exit 0
